import streamlit as st
import pandas as pd
import geopandas as gpd
from shapely.geometry import Polygon
from shapely import wkt
from shapely.geometry import Polygon, MultiPolygon
import folium
from streamlit_folium import st_folium
from pathlib import Path
from folium.plugins import StripePattern

col1, col2 = st.columns([1,1])
if col1.button("üè† Home"):
    st.switch_page("app.py")
if col2.button("üó∫Ô∏è Mapa"):
    st.switch_page("pages/mapa.py")


st.set_page_config(page_title="Mapa de Reclama√ß√µes", layout="wide")
st.title("üó∫Ô∏è Mapa de calor - Reclama√ß√µes por Estado / Munic√≠pio")

df_filtrado = st.session_state['df_filtrado']
gdf_estados = st.session_state.get('gdf_estados')

# --- Fun√ß√£o para carregar o GeoDataFrame das localidades ---
@st.cache_data(ttl=3600)
def load_localidade_geodf(path):
    df = pd.read_csv(path, sep=',')  # ajuste o separador se necess√°rio

    if 'POLYGON' not in df.columns:
        st.error(f"Coluna 'POLYGON' n√£o encontrada. Colunas dispon√≠veis: {df.columns.tolist()}")
        return gpd.GeoDataFrame()

    # Converte string WKT -> objetos shapely (Polygon ou MultiPolygon)
    def to_geom(s):
        try:
            return wkt.loads(s)
        except Exception as e:
            st.error(f"Erro convertendo '{s[:50]}...': {e}")
            return None

    df['geometry'] = df['POLYGON'].apply(to_geom)

    gdf = gpd.GeoDataFrame(df, geometry='geometry', crs="EPSG:4326")
    return gdf


# Seletor de localidade
st.sidebar.header("Selecione a localidade")
opcoes_estados = sorted(gdf_estados['NM_UF'].unique())
opcoes_completas = ['Todos'] + opcoes_estados
estado = st.sidebar.selectbox("Estado", options=opcoes_completas)

st.sidebar.header("Selecione o ano")
opcoes_anos = sorted(df_filtrado['ANO'].unique())
todas_opcoes = ['Todos'] + opcoes_anos
ano = st.sidebar.selectbox("Ano", options=todas_opcoes)

if ano != 'Todos':
    df_mapa = df_filtrado[df_filtrado['ANO'] == ano]
else:
    df_mapa = df_filtrado.copy()

# **Mapa do Brasil com heatmap** mostrando a quantidade de reclama√ß√µes por **ano**, com granularidade por **estado ou munic√≠pio**.
#  > O mapa **deve conter um seletor para o ano** que ser√° visualizado.
st.markdown("Para apresentar as informa√ß√µes por munic√≠pios, selecione um estado nos filtros laterais")

# Verifica se o DataFrame df_mapa est√° vazio
if df_mapa.empty:
    st.warning("Nenhuma reclama√ß√£o encontrada para o ano selecionado. Por favor, ajuste os filtros.")
    st.stop()  # Interrompe a execu√ß√£o do restante do c√≥digo

# Identificar a regi√£o do Brasil a ser exibida no mapa pelo estado selecionado
if estado == 'Todos':
    gdf_mapa = gdf_estados.copy()
else:
    if estado in ["Acre", "Amazonas", "Roraima", "Rond√¥nia", "Tocantins", "Amap√°", "Par√°"]:
        gdf_municipios_norte = load_localidade_geodf("./datasets/gdf_municipios_norte.csv")
        gdf_mapa = gdf_municipios_norte.copy()
    elif estado in ["Alagoas", "Bahia", "Cear√°", "Maranh√£o", "Para√≠ba", "Pernambuco", "Piau√≠", "Rio Grande do Norte", "Sergipe"]:
        gdf_municipios_nordeste = load_localidade_geodf("./datasets/gdf_municipios_nordeste.csv")
        gdf_mapa = gdf_municipios_nordeste.copy()
    elif estado in ["Distrito Federal", "Goi√°s", "Mato Grosso", "Mato Grosso do Sul"]:
        gdf_municipios_centro_oeste = load_localidade_geodf("./datasets/gdf_municipios_centro_oeste.csv")
        gdf_mapa = gdf_municipios_centro_oeste.copy()
    elif estado in ["Esp√≠rito Santo", "Minas Gerais", "Rio de Janeiro", "S√£o Paulo"]:
        gdf_municipios_sudeste = load_localidade_geodf("./datasets/gdf_municipios_sudeste.csv")
        gdf_mapa = gdf_municipios_sudeste.copy()
    elif estado in ["Paran√°", "Rio Grande do Sul", "Santa Catarina"]:
        gdf_municipios_sul = load_localidade_geodf("./datasets/gdf_municipios_sul.csv")
        gdf_mapa = gdf_municipios_sul.copy()
    else:
        st.error("Estado selecionado n√£o pertence a nenhuma regi√£o reconhecida.")
        st.stop()

# Verifica se o DataFrame df_mapa est√° vazio
if gdf_mapa.empty:
    st.warning("Nenhuma reclama√ß√£o encontrada no estado selecionado. Por favor, ajuste os filtros.")
    st.stop()  # Interrompe a execu√ß√£o do restante do c√≥digo

if estado != 'Todos':
    df_mapa = df_mapa[df_mapa['NOME_UF'] == estado]
    gdf_municipios = gdf_mapa[gdf_mapa["NM_UF"] == estado]

    # Centralizar o mapa na √°rea de interesse
    mapa = folium.Map(location=[gdf_municipios.geometry.centroid.y.mean(), gdf_municipios.geometry.centroid.x.mean()], zoom_start=6.3)

    # Agrupando informa√ß√µes dos estados
    df_mapa = df_mapa.groupby(['MUNICIPIO']).size().reset_index(name='Qtd_Reclamacoes')

    # Substituindo valores nulos
    df_mapa['Qtd_Reclamacoes'] = df_mapa['Qtd_Reclamacoes'].fillna(0).astype(int)

    # Unificando com os dados de localiza√ß√£o de cada estado
    gdf_final = gdf_municipios.merge(df_mapa, left_on='NM_MUN', right_on='MUNICIPIO', how='left')

    cols = ['MUNICIPIO', 'NM_MUN', 'AREA_KM2', 'Qtd_Reclamacoes', 'geometry']

    gdf_final = gdf_final[cols]

    # Simplificando a geometria para melhorar o desempenho do mapa
    gdf_final['geometry'] = gdf_final['geometry'].simplify(0.01, preserve_topology=True)

    # Adicionando as informa√ß√µes no mapa
    choropleth = folium.Choropleth(
        geo_data=gdf_final,
        name='choropleth',
        data=gdf_final,
        columns=['MUNICIPIO', 'Qtd_Reclamacoes'],
        key_on='feature.properties.NM_MUN', # Chave no GeoJSON para conectar os dados
        fill_color='YlOrRd', # Nome do colormap (escala de cores)
        nan_fill_color='grey',
        nan_fill_opacity=0.4,
        fill_opacity=0.7,
        line_opacity=0.2,
        legend_name='Quantidade de Reclama√ß√µes',
        highlight=True, # Destaca a √°rea ao passar o mouse
    )

    choropleth.add_to(mapa)

    # --- Adicionar Tooltips Interativos (Informa√ß√£o no Hover) ---
    tooltip = folium.features.GeoJsonTooltip(
        fields=['NM_MUN', 'AREA_KM2', 'Qtd_Reclamacoes'],
        aliases=['Munic√≠pio:', '√Årea (Km¬≤):', 'N¬∞ de Reclama√ß√µes:'],
        style="background-color: white; color: #333333; font-family: arial; font-size: 12px; padding: 10px;",
        sticky=True
    )

    tooltip.add_to(choropleth.geojson)

else:

    # Agrupando informa√ß√µes dos estados
    df_mapa = df_mapa.groupby(['NOME_UF']).size().reset_index(name='Qtd_Reclamacoes')

    # Substituindo valores nulos
    df_mapa['Qtd_Reclamacoes'] = df_mapa['Qtd_Reclamacoes'].fillna(0).astype(int)

    # Unificando com os dados de localiza√ß√£o de cada estado
    gdf_final = gdf_estados.merge(df_mapa, left_on='NM_UF', right_on='NOME_UF', how='left')

    cols = ['NOME_UF', 'NM_UF', 'AREA_KM2', 'Qtd_Reclamacoes', 'geometry']

    gdf_final = gdf_final[cols]

    # Centralizar o mapa na √°rea de interesse
    mapa = folium.Map(location=[gdf_final.geometry.centroid.y.mean(), gdf_final.geometry.centroid.x.mean()], zoom_start=4.3)

    # Simplificando a geometria para melhorar o desempenho do mapa
    gdf_final['geometry'] = gdf_final['geometry'].simplify(0.01, preserve_topology=True)

    # Adicionando as informa√ß√µes no mapa
    choropleth = folium.Choropleth(
        geo_data=gdf_final,
        name='choropleth',
        data=gdf_final,
        columns=['NOME_UF', 'Qtd_Reclamacoes'],
        key_on='feature.properties.NM_UF', # Chave no GeoJSON para conectar os dados
        fill_color='YlOrRd', # Nome do colormap (escala de cores)
        nan_fill_color='grey',
        nan_fill_opacity=0.4,
        fill_opacity=0.7,
        line_opacity=0.2,
        legend_name='Quantidade de Reclama√ß√µes',
        bins=[1, 20, 40, 80, 160, 320, 660],
        highlight=True, # Destaca a √°rea ao passar o mouse
    )

    choropleth.add_to(mapa)

    # --- Adicionar Tooltips Interativos (Informa√ß√£o no Hover) ---
    tooltip = folium.features.GeoJsonTooltip(
        fields=['NM_UF', 'AREA_KM2', 'Qtd_Reclamacoes'],
        aliases=['Estado:', '√Årea (Km¬≤):', 'N¬∞ de Reclama√ß√µes:'],
        style="background-color: white; color: #333333; font-family: arial; font-size: 12px; padding: 10px;",
        sticky=True
    )

    tooltip.add_to(choropleth.geojson)

    
st_folium(mapa, width=1100, height=800, returned_objects=[])